"""
math_game.py ‚Äì Êï∏Â≠∏Â•áÂπªÂÜíÈö™ÔºàÂäüËÉΩÂ¢ûÂº∑ÁâàÔºâ

üëæ ÁâπËâ≤
    ‚Ä¢ ÁôªÂÖ• / Ë®ªÂÜäÔºàÂ∏≥Ëôü„ÄÅÂØÜÁ¢º„ÄÅÊúÄÈ´òÂàÜÔºâ
    ‚Ä¢ ‰∏ªÈÅ∏ÂñÆÔºàÈñãÂßãÈÅäÊà≤ / ËøîÂõûÔºâ
    ‚Ä¢ ÂõõÂâáÈÄüÁÆóÔºöÔºã„ÄÅÔºç„ÄÅ√ó„ÄÅ√∑ÔºàÁ¢∫‰øù √∑ ÁöÑÁ≠îÊ°àÁÇ∫Ê≠£Êï¥Êï∏Ôºâ
    ‚Ä¢ 20 Á¥öÔºåÊØèÁ¥ö 10 È°åÔºõÊØèÂçá 1 Á¥öÔºåË®àÊôÇ * 0.9ÔºåÊúÄÁü≠ 3‚ÄØs
    ‚Ä¢ Êö´ÂÅú„ÄÅÂ≠òÊ™î„ÄÅÁ∫åÁé©
    ‚Ä¢ Âç≥ÊôÇÊéíË°åÊ¶úÔºàÂâç 5 ÂêçÔºâ
    ‚Ä¢ ÊîØÊè¥Ë∑®Ê¨°ÈÅäÊà≤Á∫åÊé•ÂÄã‰∫∫ÈÄ≤Â∫¶

Âü∑Ë°åÔºö
    python math_game.py
"""

# --------------------------------------------------
#  Imports
# --------------------------------------------------
import os
import json
import random
import tkinter as tk
from tkinter import ttk, font, messagebox

# --------------------------------------------------
#  Ê™îÊ°àË∑ØÂæë & Â∏∏Êï∏Ë®≠ÂÆö
# --------------------------------------------------
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DATA_DIR = BASE_DIR  # ‚á® ËàáÁ®ãÂºèÊîæÂêåÂ±§

USERS_FILE = os.path.join(DATA_DIR, "math_game_users.json")
STATE_FILE = os.path.join(DATA_DIR, "math_game_state.json")

MAX_LEVEL            = 20       # ÊúÄÂ§ö 20 Èóú
QUESTIONS_PER_LEVEL  = 10       # ÊØèÈóú 10 È°å
TIME_SHRINK_RATE     = 0.9      # ÂçáÁ¥öÂæåÊôÇÈñìÂÄçÁéá
BASE_TIME_LIMIT      = 15.0     # Ëµ∑ÂßãÁ≠îÈ°åÁßíÊï∏
MIN_TIME_LIMIT       = 3.0      # ÊúÄ‰ΩéÁßíÊï∏

print("üìÅ Áî®Êà∂Ë≥áÊñôÔºö", USERS_FILE)
print("üìÅ ÈÄ≤Â∫¶Ë≥áÊñôÔºö", STATE_FILE)

# --------------------------------------------------
#  ‰∏ª GUI È°ûÂà•
# --------------------------------------------------
class MathGameGUI:
    """Tkinter GUI ‚Äì Êï∏Â≠∏Â•áÂπªÂÜíÈö™"""

    # ------------------------------
    #  ÂàùÂßãÂåñ
    # ------------------------------
    def __init__(self, master: tk.Tk):
        self.master = master
        master.title("üéÆ Êï∏Â≠∏Â•áÂπªÂÜíÈö™ üéÆ")
        master.state('zoomed')
        master.configure(bg="#0B0C10")

        # ‚Äî‚Äî‚Äî Â≠óÈ´î ‚Äî‚Äî‚Äî
        self.title_font = font.Font(family="Comic Sans MS", size=48, weight="bold")
        self.ui_font    = font.Font(family="ÂæÆËªüÊ≠£ÈªëÈ´î",   size=16)
        self.q_font     = font.Font(family="Arial",        size=32, weight="bold")

        # ‚Äî‚Äî‚Äî ËºâÂÖ•Ë≥áÊñô ‚Äî‚Äî‚Äî
        self.users  = self._load_json(USERS_FILE)
        self.states = self._load_json(STATE_FILE)

        # ‚Äî‚Äî‚Äî ‰∏âÂ§ßÁï´Èù¢ ‚Äî‚Äî‚Äî
        self.login_frame = tk.Frame(master, bg="#0B0C10")
        self.menu_frame  = tk.Frame(master, bg="#0B0C10")
        self.game_frame  = tk.Frame(master, bg="#0B0C10")

        # Âª∫ÊßãÂêÑÂçÄÂüü
        self._build_login()
        self._build_menu()
        self._build_game()

        # ÂÖàÈ°ØÁ§∫ÁôªÂÖ•Áï´Èù¢
        self.login_frame.pack(fill="both", expand=True)

    # ==================================================
    #  Ê™îÊ°à I/O
    # ==================================================
    def _load_json(self, path: str) -> dict:
        if os.path.exists(path):
            try:
                with open(path, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except json.JSONDecodeError:
                return {}
        return {}

    def _save_json(self, path: str, data: dict) -> None:
        with open(path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)

    # ==================================================
    #  ÁôªÂÖ• / Ë®ªÂÜä
    # ==================================================
    def _build_login(self) -> None:
        panel = tk.Frame(self.login_frame, bg="#1F2833", bd=2, relief="ridge")
        panel.place(relx=0.5, rely=0.5, anchor="center", width=600, height=400)

        tk.Label(panel,
                 text="üåü Êï∏Â≠∏Â•áÂπªÂÜíÈö™ üåü",
                 font=self.title_font,
                 fg="#FFD700",
                 bg="#1F2833").pack(pady=(20, 10))

        tk.Label(panel, text="Áî®Êà∂ÂêçÔºö", font=self.ui_font, fg="#FFFFFF", bg="#1F2833").pack(pady=5)
        self.login_user = tk.Entry(panel, font=self.ui_font, width=30, justify="center")
        self.login_user.pack(pady=5)

        tk.Label(panel, text="ÂØÜÁ¢ºÔºö", font=self.ui_font, fg="#FFFFFF", bg="#1F2833").pack(pady=5)
        self.login_pass = tk.Entry(panel, font=self.ui_font, show="*", width=30, justify="center")
        self.login_pass.pack(pady=5)

        tk.Button(panel,
                  text="üîë ÁôªÂÖ•",
                  font=self.ui_font,
                  bg="#00AA00",
                  fg="#FFFFFF",
                  bd=0,
                  command=self._handle_login).pack(pady=(20, 5))

        tk.Button(panel,
                  text="‚ûï Ë®ªÂÜä",
                  font=self.ui_font,
                  bg="#E94560",
                  fg="#FFFFFF",
                  bd=0,
                  command=self._open_register).pack(pady=5)

    def _handle_login(self) -> None:
        user = self.login_user.get().strip()
        pwd  = self.login_pass.get().strip()

        if user in self.users and self.users[user]['password'] == pwd:
            self.username = user
            self.login_frame.pack_forget()
            self.menu_frame.pack(fill="both", expand=True)
        else:
            messagebox.showerror("ÁôªÂÖ•Â§±Êïó", "Â∏≥ËôüÊàñÂØÜÁ¢ºÈåØË™§")

    # ---------- Ë®ªÂÜä ----------
    def _open_register(self) -> None:
        dlg = tk.Toplevel(self.master)
        dlg.title("‚ûï Ë®ªÂÜäÊñ∞Â∏≥Ëôü")
        dlg.configure(bg="#1F2833")
        dlg.geometry("400x260")
        dlg.resizable(False, False)
        dlg.transient(self.master)
        dlg.grab_set()

        tk.Label(dlg,
                 text="‚ûï Êñ∞Â∏≥ËôüË®ªÂÜä",
                 font=self.ui_font,
                 fg="#FFFFFF",
                 bg="#16202A").pack(fill="x")

        content = tk.Frame(dlg, bg="#1F2833")
        content.pack(expand=True, fill="both", padx=20, pady=20)

        tk.Label(content, text="Áî®Êà∂ÂêçÔºö", font=self.ui_font, fg="#CCCCCC", bg="#1F2833").grid(row=0, column=0, sticky="e", pady=8)
        entry_user = tk.Entry(content, font=self.ui_font, width=25, justify="center")
        entry_user.grid(row=0, column=1, pady=8, padx=(10, 0))

        tk.Label(content, text="ÂØÜÁ¢ºÔºö", font=self.ui_font, fg="#CCCCCC", bg="#1F2833").grid(row=1, column=0, sticky="e", pady=8)
        entry_pwd = tk.Entry(content, font=self.ui_font, width=25, show="*", justify="center")
        entry_pwd.grid(row=1, column=1, pady=8, padx=(10, 0))

        btn_frame = tk.Frame(dlg, bg="#1F2833")
        btn_frame.pack(fill="x", pady=(0, 20))

        tk.Button(btn_frame,
                  text="ÂèñÊ∂à",
                  font=self.ui_font,
                  bg="#555555",
                  fg="#FFFFFF",
                  bd=0,
                  command=dlg.destroy).pack(side="left", expand=True, padx=20)

        tk.Button(btn_frame,
                  text="Ë®ªÂÜä",
                  font=self.ui_font,
                  bg="#E94560",
                  fg="#FFFFFF",
                  bd=0,
                  command=lambda: self._handle_register(entry_user.get(), entry_pwd.get(), dlg)).pack(side="right", expand=True, padx=20)

    def _handle_register(self, user: str, pwd: str, dlg: tk.Toplevel) -> None:
        if not user or not pwd:
            messagebox.showwarning("Ëº∏ÂÖ•ÈåØË™§", "Ë´ãÂ°´ÂØ´ÂÆåÊï¥Ë≥áÊñô")
            return

        if user in self.users:
            messagebox.showinfo("ÊèêÁ§∫", "Â∏≥ËôüÂ∑≤Â≠òÂú®")
            return

        self.users[user] = {"password": pwd, "score": 0}
        self._save_json(USERS_FILE, self.users)
        messagebox.showinfo("Ë®ªÂÜäÊàêÂäü", "Ë´ã‰ΩøÁî®Êñ∞Â∏≥ËôüÁôªÂÖ•")
        dlg.destroy()

    # ==================================================
    #  ‰∏ªÈÅ∏ÂñÆ
    # ==================================================
    def _build_menu(self) -> None:
        tk.Button(self.menu_frame,
                  text="‚ñ∂Ô∏è ÈñãÂßãÈÅäÊà≤",
                  font=self.ui_font,
                  bg="#00AA00",
                  fg="#FFFFFF",
                  bd=0,
                  command=self._on_start_game).pack(expand=True)
        tk.Button(self.menu_frame,
                  text="üîô ÁôªÂá∫",
                  font=self.ui_font,
                  bg="#555555",
                  fg="#FFFFFF",
                  bd=0,
                  command=self._logout).pack()
    def _on_start_game(self) -> None:
        self.menu_frame.pack_forget()
        self._start_game()

    # ==================================================
    #  ÈÅäÊà≤Áï´Èù¢
    # ==================================================
    def _build_game(self) -> None:
        # ---------- Header ----------
        header = tk.Frame(self.game_frame, bg="#1F2833")
        header.pack(fill="x")

        self.user_label = tk.Label(header, text="", font=self.ui_font, fg="#66FCF1", bg="#1F2833")
        self.user_label.pack(side="left", padx=20)

        self.score_label = tk.Label(header, text="ÂàÜÊï∏Ôºö0  Á≠âÁ¥öÔºö1", font=self.title_font, fg="#00FF00", bg="#1F2833")
        self.score_label.pack(side="left", padx=50)

        tk.Button(header,
                  text="‚è∏ Êö´ÂÅú",
                  font=self.ui_font,
                  bg="#555555",
                  fg="#FFFFFF",
                  bd=0,
                  command=self._pause_game).pack(side="right", padx=10)

        # ---------- Body ----------
        body = tk.Frame(self.game_frame, bg="#0B0C10")
        body.pack(expand=True, fill="both")

        card = tk.Frame(body, bg="#45A29E", bd=8, relief="ridge")
        card.place(relx=0.5, rely=0.25, anchor="center", relwidth=0.6, relheight=0.2)

        self.question_label = tk.Label(card, text="", font=self.q_font, fg="#FFFFFF", bg="#45A29E")
        self.question_label.pack(expand=True)

        self.entry = tk.Entry(body, font=self.ui_font, justify="center")
        self.entry.place(relx=0.5, rely=0.5, anchor="center", width=300)
        self.entry.bind("<Return>", lambda _e: self._check_answer())

        self.submit_btn = tk.Button(body, text="‚úîÔ∏è Êèê‰∫§", font=self.ui_font, bg="#0099FF", fg="#FFFFFF", bd=0, command=self._check_answer)
        self.submit_btn.place(relx=0.5, rely=0.6, anchor="center")

        # ---------- Timer ----------
        self.timer_label = tk.Label(body, text="Ââ©È§òÊôÇÈñìÔºö", font=self.ui_font, fg="#FFAA00", bg="#0B0C10")
        self.timer_label.place(relx=0.5, rely=0.7, anchor="center")

        style = ttk.Style()
        style.theme_use('clam')
        style.configure('Timer.Horizontal.TProgressbar', troughcolor="#000000", thickness=20, background="#00FF00")
        style.configure('Red.Horizontal.TProgressbar', background="#FF0000")

        self.timerbar = ttk.Progressbar(body, style='Timer.Horizontal.TProgressbar', maximum=100)
        self.timerbar.place(relx=0.5, rely=0.75, anchor="center", relwidth=0.6)

        # ---------- Leaderboard ----------
        board_frame = tk.Frame(self.game_frame, bg="#1F2833")
        board_frame.pack(fill="x", pady=(20, 0))

        tk.Label(board_frame, text="üèÜ ÊéíË°åÊ¶ú üèÜ", font=self.ui_font, fg="#FFCE00", bg="#1F2833").pack(pady=(5, 2))

        self.board = ttk.Treeview(board_frame, columns=("Áé©ÂÆ∂", "ÂàÜÊï∏"), show="headings", height=5)
        self.board.heading("Áé©ÂÆ∂", text="Áé©ÂÆ∂")
        self.board.heading("ÂàÜÊï∏", text="ÂàÜÊï∏")
        self.board.column("Áé©ÂÆ∂", anchor="center")
        self.board.column("ÂàÜÊï∏", anchor="center")
        self.board.pack(padx=20, pady=(0, 10))

    # ==================================================
    #  ÈÅäÊà≤ÊµÅÁ®ãÊéßÂà∂
    # ==================================================
    def _prompt_continue(self) -> bool:
        """Ë©¢ÂïèÊòØÂê¶Êé•Á∫åËàäÈÄ≤Â∫¶"""
        dlg = tk.Toplevel(self.master)
        dlg.title("Á∫åÁé©ÈÄ≤Â∫¶Ôºü")
        dlg.configure(bg="#1F2833")
        dlg.geometry("400x150")

        tk.Label(dlg, text="ÂÅµÊ∏¨Âà∞ËàäÈÄ≤Â∫¶ÔºåÊòØÂê¶ÁπºÁ∫åÔºü", font=self.ui_font, fg="#FFFFFF", bg="#1F2833").pack(pady=20)

        frm = tk.Frame(dlg, bg="#1F2833")
        frm.pack()

        result = {"yes": False}

        tk.Button(frm,
                  text="ÊòØ",
                  font=self.ui_font,
                  bg="#00AA00",
                  fg="#FFFFFF",
                  bd=0,
                  command=lambda: (result.update({"yes": True}), dlg.destroy())).pack(side="left", padx=10)

        tk.Button(frm,
                  text="Âê¶",
                  font=self.ui_font,
                  bg="#AA0000",
                  fg="#FFFFFF",
                  bd=0,
                  command=dlg.destroy).pack(side="right", padx=10)

        dlg.transient(self.master)
        dlg.grab_set()
        self.master.wait_window(dlg)
        return result["yes"]

    def _start_game(self) -> None:
        """ÂàùÂßãÂåñ / ÂõûÂæ© ÈÅäÊà≤ÁãÄÊÖã"""
        self.game_frame.pack(fill="both", expand=True)

        # È°ØÁ§∫ÂêçÁ®±
        self.user_label.config(text=f"Áé©ÂÆ∂Ôºö{self.username}")

        # ËÆÄÂèñËàäÈÄ≤Â∫¶
        state = self.states.get(self.username)
        if state and self._prompt_continue():
            self.score       = state['score']
            self.level       = state['level']
            self.time_limit  = state['time_limit']
            self.correct_cnt = state.get('correct_cnt', 0)
        else:
            self.score       = 0
            self.level       = 1
            self.time_limit  = BASE_TIME_LIMIT
            self.correct_cnt = 0
            self._clear_state()

        self.time_left = self.time_limit
        self._update_status()
        self._refresh_leaderboard()
        self._next_question()
        self._run_timer()

    # ------------------------------
    #  ÁãÄÊÖãÂà∑Êñ∞
    # ------------------------------
    def _update_status(self) -> None:
        self.score_label.config(text=f"ÂàÜÊï∏Ôºö{self.score}  Á≠âÁ¥öÔºö{self.level}")

    def _refresh_leaderboard(self) -> None:
        self.board.delete(*self.board.get_children())
        ranking = sorted(self.users.items(), key=lambda x: x[1]['score'], reverse=True)[:5]
        for user, data in ranking:
            self.board.insert('', 'end', values=(user, data['score']))

    # ------------------------------
    #  Âá∫È°åÈÇèËºØ
    # ------------------------------
    def _generate_question(self) -> str:
        """Èö®Ê©üÁîüÊàê‰∏ÄÈ°åÂõõÂâáÈÅãÁÆóÔºå√∑ È°åÁ¢∫‰øùÊï¥Èô§"""
        op_list = ['+', '-', '*', '/']
        op = random.choice(op_list)
        max_num = 5 + self.level * 5

        if op == '/':
            divisor   = random.randint(1, max_num)
            quotient  = random.randint(1, max_num)
            dividend  = divisor * quotient
            a, b, ans = dividend, divisor, quotient
        else:
            a = random.randint(1, max_num)
            b = random.randint(1, max_num)

            if op == '-' and a < b:
                a, b = b, a  # ÈÅøÂÖçË≤†Êï∏

            if op == '+':
                ans = a + b
            elif op == '-':
                ans = a - b
            else:  # '*'
                ans = a * b

        disp_op = {'+': '+', '-': '-', '*': '√ó', '/': '√∑'}[op]
        self.answer = ans
        return f"{a} {disp_op} {b} = ?"

    def _next_question(self) -> None:
        if self.level > MAX_LEVEL:
            self._end_game("üéâ ÊÅ≠ÂñúÈÄöÈóúÔºÅ")
            return

        self.time_left = self.time_limit
        q_text = self._generate_question()
        self.question_label.config(text=q_text)

        self.entry.delete(0, tk.END)
        self.timerbar.config(value=100, style='Timer.Horizontal.TProgressbar')
        self.timer_label.config(text=f"Ââ©È§òÊôÇÈñìÔºö{self.time_left:.1f}s")

    # ------------------------------
    #  Timer
    # ------------------------------
    def _run_timer(self) -> None:
        if self.time_left > 0:
            pct = int(100 * self.time_left / self.time_limit)
            self.timerbar['value'] = pct

            if self.time_left <= 5:
                self.timerbar.config(style='Red.Horizontal.TProgressbar')

            self.timer_label.config(text=f"Ââ©È§òÊôÇÈñìÔºö{self.time_left:.1f}s")

            self.time_left -= 1
            self.timer_id = self.master.after(1000, self._run_timer)
        else:
            self._end_game("‚è∞ ÊôÇÈñìÂà∞ÔºÅ")

    # ------------------------------
    #  Á≠îÈ°åÂà§ÂÆö
    # ------------------------------
    def _check_answer(self) -> None:
        # ÂÅúË®àÊôÇ
        if hasattr(self, 'timer_id'):
            self.master.after_cancel(self.timer_id)

        # ËΩâ int
        try:
            user_ans = int(self.entry.get())
        except ValueError:
            messagebox.showwarning("Ëº∏ÂÖ•ÁÑ°Êïà", "Ë´ãËº∏ÂÖ•Êï∏Â≠ó")
            self._run_timer()
            return

        # Âà§ÂàÜ
        if user_ans == self.answer:
            self.score += 1
            self.correct_cnt += 1

            if self.correct_cnt >= QUESTIONS_PER_LEVEL:
                self.level += 1
                self.correct_cnt = 0
                self.time_limit = max(MIN_TIME_LIMIT, self.time_limit * TIME_SHRINK_RATE)

            # Êõ¥Êñ∞ÂÄã‰∫∫ÊúÄ‰Ω≥
            if self.score > self.users[self.username]['score']:
                self.users[self.username]['score'] = self.score
                self._save_json(USERS_FILE, self.users)

            self._update_status()
            self._refresh_leaderboard()
            self._next_question()
            self._run_timer()
        else:
            self._end_game("‚ùå Á≠îÈåØ‰∫ÜÔºÅ")

    # ==================================================
    #  Êö´ÂÅú / ÂÑ≤Â≠ò
    # ==================================================
    def _pause_game(self) -> None:
        if hasattr(self, 'timer_id'):
            self.master.after_cancel(self.timer_id)
            del self.timer_id

        dlg = tk.Toplevel(self.master)
        dlg.title("ÈÅäÊà≤Êö´ÂÅú")
        dlg.configure(bg="#1F2833")
        dlg.geometry("300x150")

        tk.Label(dlg, text="ÈÅäÊà≤Â∑≤Êö´ÂÅú", font=self.q_font, fg="#FFFFFF", bg="#1F2833").pack(pady=10)

        frm = tk.Frame(dlg, bg="#1F2833")
        frm.pack(pady=10)

        def on_continue():
            dlg.destroy()
            self._run_timer()

        def on_quit():
            dlg.destroy()
            self._save_state()
            self.game_frame.pack_forget()
            self.menu_frame.pack(fill="both", expand=True)

        tk.Button(frm, text="ÂÑ≤Â≠ò‰∏¶ÈÄÄÂá∫", font=self.ui_font, bg="#AA0000", fg="#FFFFFF", bd=0, command=on_quit).pack(side="left", padx=5)
        tk.Button(frm, text="ÁπºÁ∫å", font=self.ui_font, bg="#00AA00", fg="#FFFFFF", bd=0, command=on_continue).pack(side="right", padx=5)

        dlg.protocol("WM_DELETE_WINDOW", on_continue)

    # ==================================================
    #  ÈÅäÊà≤ÁµêÊùü
    # ==================================================
    def _end_game(self, msg: str) -> None:
        if hasattr(self, 'timer_id'):
            self.master.after_cancel(self.timer_id)

        dlg = tk.Toplevel(self.master)
        dlg.title("ÈÅäÊà≤ÁµêÊùü")
        dlg.configure(bg="#1F2833")
        dlg.geometry("300x180")

        tk.Label(dlg, text=msg, font=self.q_font, fg="#FFFFFF", bg="#1F2833").pack(pady=10)
        tk.Label(dlg, text=f"‰Ω†ÁöÑÂàÜÊï∏Ôºö{self.score}", font=self.ui_font, fg="#FFFF00", bg="#1F2833").pack(pady=5)

        frm = tk.Frame(dlg, bg="#1F2833")
        frm.pack(pady=10)

        def on_retry():
            dlg.destroy()
            self._play_again()

        def on_exit():
            dlg.destroy()
            self._clear_state()
            self.game_frame.pack_forget()
            self.menu_frame.pack(fill="both", expand=True)

        tk.Button(frm, text="ÂÜçÁé©‰∏ÄÂ±Ä", font=self.ui_font, bg="#00AA00", fg="#FFFFFF", bd=0, command=on_retry).pack(side="left", padx=5)
        tk.Button(frm, text="ÈÄÄÂá∫", font=self.ui_font, bg="#AA0000", fg="#FFFFFF", bd=0, command=on_exit).pack(side="right", padx=5)

        dlg.protocol("WM_DELETE_WINDOW", on_exit)

    def _play_again(self) -> None:
        self.score       = 0
        self.level       = 1
        self.correct_cnt = 0
        self.time_limit  = BASE_TIME_LIMIT
        self.time_left   = self.time_limit

        self._update_status()
        self._next_question()
        self._run_timer()

    def _logout(self) -> None:
        """ÁôªÂá∫ÂõûÁôªÂÖ•È†Å"""
        if hasattr(self, 'timer_id'):
            self.master.after_cancel(self.timer_id)

        self._save_json(USERS_FILE, self.users)
        self._save_json(STATE_FILE, self.states)

        self.game_frame.pack_forget()
        self.menu_frame.pack_forget()
        self.login_frame.pack(fill="both", expand=True)

        self.login_user.delete(0, tk.END)
        self.login_pass.delete(0, tk.END)



    # ==================================================
    #  Save / Load State
    # ==================================================
    def _save_state(self) -> None:
        self.states[self.username] = {
            'score':       self.score,
            'level':       self.level,
            'time_limit':  self.time_limit,
            'correct_cnt': self.correct_cnt
        }
        self._save_json(STATE_FILE, self.states)
        self._save_json(USERS_FILE, self.users)

    def _clear_state(self) -> None:
        if self.username in self.states:
            del self.states[self.username]
            self._save_json(STATE_FILE, self.states)


# --------------------------------------------------
#  Á®ãÂºèÈÄ≤ÂÖ•Èªû
# --------------------------------------------------
if __name__ == '__main__':
    root = tk.Tk()
    app  = MathGameGUI(root)
    root.mainloop()
